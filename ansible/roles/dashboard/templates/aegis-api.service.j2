[Unit]
Description=Aegis Control Plane API
After=network.target wg-quick@{{ wg_interface }}.service
Requires=wg-quick@{{ wg_interface }}.service

[Service]
User={{ aegis_system_user }}
Group={{ aegis_system_user }}
WorkingDirectory={{ dashboard_app_dir }}

Environment="AEGIS_AUTH_ENABLED={{ 'true' if dashboard_enable_auth else 'false' }}"
Environment="AEGIS_AUTH_TOKEN={{ dashboard_auth_token }}"
Environment="WG_INTERFACE={{ wg_interface }}"
Environment="WG_SUBNET_BASE={{ wg_server_ip | regex_replace('\\.[0-9]+$', '.') }}"
Environment="WG_ENDPOINT={{ ansible_host }}:{{ wg_port }}"
Environment="WG_SERVER_PUBLIC_KEY_PATH={{ dashboard_app_dir }}/server_public.key"
Environment="PEER_LABELS_PATH={{ dashboard_labels_path }}"
Environment="GEO_DB_PATH={{ dashboard_geo_db_path }}"
Environment="WG_HANDSHAKE_THRESHOLD={{ wg_handshake_threshold }}"

ExecStart={{ dashboard_venv_dir }}/bin/uvicorn app.main:app \
  --host {{ dashboard_bind_host }} \
  --port {{ dashboard_bind_port }}

Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
